<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Book Sales Memo Generator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; color: #333; }
        #app { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label, select, button { display: block; margin-bottom: 15px; font-size: 1.1em; }
        select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .input-group { display:flex; gap:20px; margin-top:15px; margin-bottom:10px; }
        .input-group>div { flex:1; }
        .input-group label { margin-bottom:5px; font-size:1em; }
        .input-group input[type="text"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; font-size:1em; box-sizing:border-box; }
        button { background-color:#28a745; color:white; padding:12px 20px; border:none; border-radius:4px; cursor:pointer; font-size:1em; transition:background-color .3s; margin-top:10px; }
        button:hover{ background-color:#218838; }
        #books-list { margin-top:20px; padding:15px; border:1px solid #ddd; border-radius:4px; min-height:40px; }
        .data-table { width:100%; border-collapse: collapse; margin-top:15px; }
        .data-table th, .data-table td { border:1px solid #eee; padding:10px; text-align:left; font-size:.9em; vertical-align: middle; }
        .data-table th { background-color:#007bff; color:white; }
        .data-table tr:nth-child(even) { background-color:#f9f9f9; }
        .data-table input[type="checkbox"] { transform:scale(1.2); cursor:pointer; margin-right:10px; vertical-align:middle; }
        #select-all-header { display:flex; align-items:center; padding:10px; width:100%; height:100%; }
        #select-all-text { cursor:pointer; padding:5px; margin-left:-5px; flex-grow:1; }
        #select-all-header:hover { background-color:#0069d9; }
        .data-table input[type="number"] { width:60px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:3px; }
        .total-row { font-weight:bold; background-color:#fff3cd !important; color:#856404; }
        .memo-container { border:2px solid #333; padding:30px; margin-top:40px; display:none; max-width:700px; }
        .memo-header { text-align:center; border-bottom:3px double #333; margin-bottom:10px; padding-bottom:5px; }
        .memo-header h2 { margin:0; color:#333; font-size:1.3em; }
        .memo-header p { margin:2px 0; font-size:1em; }
        .memo-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:.95em; }
        .memo-table th, .memo-table td { border:1px solid #999; padding:6px 9px; text-align:left; }
        .memo-table th { background-color:#e9ecef; font-size:1em; }
        .memo-table th:nth-child(1){ width:5%; } .memo-table th:nth-child(2){ width:55%; } .memo-table th:nth-child(3){ width:15%; } .memo-table th:nth-child(4){ width:10%; } .memo-table th:nth-child(5){ width:15%; }

        @media print {
            body > #app > *:not(.memo-container) { display:none !important; }
            .memo-container { display:block !important; border:none; padding:0; margin:0 auto; width:100%; box-shadow:none; }
            .memo-header { border-bottom:3px double #333; margin-bottom:4mm; padding-bottom:2mm; }
            @page { size: A4; margin: 8mm 10mm 8mm 10mm;
                @bottom-left { content: "System_Designed_&_Developed_by/NA_Niloy"; font-size:8pt; color:#000000; }
                @bottom-right { content:none; }
            }
        }

        /* small loader */
        .loader { display:inline-block; padding:4px 8px; background:#e9ecef; border-radius:4px; font-size:.9em; margin-left:8px;}
    </style>
</head>
<body>
    <div id="app">
        <h1>üìö Book Sales Memo Generator</h1>

        <label for="class-select">Select Class:</label>
        <select id="class-select" onchange="displayBooks()">
            <option value="">-- Select Class --</option>
        </select>

        <div class="input-group">
            <div>
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student's name (optional)">
            </div>
            <div>
                <label for="student-id">Student ID:</label>
                <input type="text" id="student-id" placeholder="Enter student's ID (optional)">
            </div>
        </div>

        <div id="books-list"></div>

        <button onclick="generateMemo()">Generate Bill, Save Data, and Print</button>
        <button onclick="resetForm()" style="background-color:#dc3545;">Create New Bill</button>

        <div id="memo-output" class="memo-container"></div>
    </div>

<script>
/* =========================
   Sheet settings (edit these)
   ========================= */
const SHEETS = [
  { name: "Nursery", gid: "0" },
  { name: "Reception", gid: "2027098770" },
  { name: "Year 1", gid: "1401175034" },
  { name: "Year 2", gid: "920652694" },
  { name: "Year 3", gid: "853416613" },
  { name: "Year 4", gid: "746344402" },
  { name: "Year 5", gid: "1210824589" },
  { name: "Year 6", gid: "863626512" },
  { name: "Year 7", gid: "790069678" },
  { name: "Year 8", gid: "622660697" },
  { name: "Year 9", gid: "2022019354" },
  { name: "Question Paper Set", gid: "596988486" }
];

// change this to your sheet id if different
const BASE = "https://docs.google.com/spreadsheets/d/1htWKKFov6IgbkJTqrhXl-EvvHzZlyWHOsNAQScfarw0/export?format=csv&gid=";


/* =========
   Utilities
   ========= */

/**
 * Robust CSV parser that handles quoted fields and commas inside quoted fields.
 * Returns array of arrays (rows -> fields)
 */
function csvToRows(str) {
  str = str.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const rows = [];
  let cur = [];
  let field = '';
  let inQuotes = false;
  for (let i = 0; i < str.length; i++) {
    const ch = str[i];
    if (inQuotes) {
      if (ch === '"') {
        if (str[i+1] === '"') { // escaped quote
          field += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        field += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',') {
        cur.push(field);
        field = '';
      } else if (ch === '\n') {
        cur.push(field);
        field = '';
        rows.push(cur);
        cur = [];
      } else {
        field += ch;
      }
    }
  }
  // push last field/row if needed
  if (field !== '' || inQuotes) {
    cur.push(field);
  }
  if (cur.length > 0) rows.push(cur);
  return rows;
}

/**
 * Parse CSV text into array of objects using header row.
 * Performs header detection (trims), and returns objects with keys exactly: Subject, Books, Price
 * If header names vary (like 'SL.' present), it will detect Subject/Books/Price by regex.
 */
function parseCSVToObjects(csvText) {
  const rows = csvToRows(csvText);
  if (!rows || rows.length === 0) return [];
  // find a header row: first row
  const headerRow = rows[0].map(h => (h || '').toString().trim());
  // map header names to column index
  const map = { Subject: -1, Books: -1, Price: -1 };
  headerRow.forEach((h, idx) => {
    const key = (h || '').replace(/\s+/g, ' ').trim().toLowerCase();
    if (/^subject\b/i.test(h) || key.includes('subject')) map.Subject = idx;
    else if (/^books?\b/i.test(h) || key.includes('book')) map.Books = idx;
    else if (/^price\b/i.test(h) || key.includes('price') || key.includes('rate') || key.includes('unit')) map.Price = idx;
    // note: we intentionally ignore SL. column
  });

  // fallback: try to find by guessing common names if not found
  if (map.Subject === -1) {
    headerRow.forEach((h, idx) => { if (/(subject|sub)/i.test(h) && map.Subject === -1) map.Subject = idx; });
  }
  if (map.Books === -1) {
    headerRow.forEach((h, idx) => { if (/(book|title)/i.test(h) && map.Books === -1) map.Books = idx; });
  }
  if (map.Price === -1) {
    headerRow.forEach((h, idx) => { if (/(price|rate|unit)/i.test(h) && map.Price === -1) map.Price = idx; });
  }

  // if still not found, try default positions (Subject maybe col 1, Books col 2, Price last)
  if (map.Subject === -1 && headerRow.length >= 2) map.Subject = 1; // hopeful
  if (map.Books === -1 && headerRow.length >= 3) map.Books = 2;
  if (map.Price === -1) map.Price = headerRow.length - 1;

  // build objects from rest rows
  const data = [];
  for (let r = 1; r < rows.length; r++) {
    const row = rows[r];
    // skip empty rows
    if (!row || row.every(c => (c || '').toString().trim() === '')) continue;
    const subject = (row[map.Subject] || '').toString().trim();
    const books = (row[map.Books] || '').toString().trim();
    let priceRaw = (row[map.Price] || '').toString().trim();

    // sanitize price: remove non-digit except dot and minus
    priceRaw = priceRaw.replace(/[^0-9.\-]/g, '');
    const price = parseFloat(priceRaw) || 0;

    data.push({ Subject: subject || '-', Books: books || '-', Price: price });
  }
  return data;
}

/* ============
   DOM Binding
   ============ */
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('class-select');
  SHEETS.forEach(s => {
    const option = document.createElement('option');
    option.value = s.name;
    option.textContent = s.name;
    select.appendChild(option);
  });
});

/* =========================
   Load CSV from Google Sheet
   ========================= */
async function loadBooksForClass(className) {
  const sheet = SHEETS.find(s => s.name === className);
  if (!sheet) return [];
  const url = BASE + sheet.gid;

  // small loading indicator
  const booksListDiv = document.getElementById('books-list');
  const loader = document.createElement('span');
  loader.className = 'loader';
  loader.textContent = 'Loading...';
  booksListDiv.innerHTML = '';
  booksListDiv.appendChild(loader);

  try {
    const resp = await fetch(url);
    if (!resp.ok) {
      console.warn('Fetch failed status:', resp.status);
      booksListDiv.innerHTML = '<div style="color:#a00;">Failed to load sheet (check sharing/public access).</div>';
      return [];
    }
    const csv = await resp.text();
    const items = parseCSVToObjects(csv);
    // remove loader
    return items;
  } catch (err) {
    console.error('Error fetching sheet:', err);
    booksListDiv.innerHTML = '<div style="color:#a00;">Error fetching sheet data. See console.</div>';
    return [];
  }
}

/* ====================================
   Display books (uses sheet-loaded data)
   ==================================== */
async function displayBooks() {
  const selectedClass = document.getElementById('class-select').value;
  const booksListDiv = document.getElementById('books-list');
  booksListDiv.innerHTML = '';

  if (!selectedClass) return;

  const books = await loadBooksForClass(selectedClass);
  if (!books || books.length === 0) {
    booksListDiv.innerHTML = '<div style="color:#555;">No books found in sheet for this class.</div>';
    window.bookData = window.bookData || {};
    window.bookData[selectedClass] = [];
    return;
  }

  let html = `<h3>Book List for ${selectedClass}</h3>`;
  html += `
    <table class="data-table">
      <thead>
        <tr>
          <th>
            <div id="select-all-header">
              <input type="checkbox" id="select-all-books" onchange="selectAllBooks(this.checked)">
              <span id="select-all-text" onclick="document.getElementById('select-all-books').click()"> Subject (Select All) </span>
            </div>
          </th>
          <th>Book Name</th>
          <th>Unit Price (BDT)</th>
          <th>Quantity</th>
          <th>Total Price (BDT)</th>
        </tr>
      </thead>
      <tbody>
  `;

  books.forEach((book, index) => {
    const bookId = `book-${index}`;
    const priceDisplay = (typeof book.Price === 'number') ? book.Price.toLocaleString() : (book.Price || '0');
    html += `
      <tr id="${bookId}-row">
        <td>
          <input type="checkbox" id="check-book-${index}" data-index="${index}" onchange="updateQuantityAndCheckbox(this, 'checkbox')">
          ${escapeHtml(book.Subject)}
        </td>
        <td>${escapeHtml(book.Books)}</td>
        <td class="unit-price" data-price="${book.Price}">${priceDisplay}</td>
        <td>
          <input type="number" min="0" value="0" id="qty-book-${index}" data-index="${index}" oninput="updateQuantityAndCheckbox(this, 'input')">
        </td>
        <td id="${bookId}-total">0</td>
      </tr>
    `;
  });

  html += `
      <tr>
        <td colspan="4" style="text-align:right;">Grand Total:</td>
        <td id="grand-total" class="total-row">0</td>
      </tr>
      </tbody>
    </table>
  `;

  booksListDiv.innerHTML = html;

  // store for later calculations
  window.bookData = window.bookData || {};
  window.bookData[selectedClass] = books;
}

/* small HTML escape helper */
function escapeHtml(str) {
  if (!str) return '';
  return str.toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* =========================
   Select/Deselect all books
   ========================= */
function selectAllBooks(checked) {
  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
  const individualCheckboxes = document.querySelectorAll('#books-list input[type="checkbox"]');

  const value = checked ? 1 : 0;

  quantityInputs.forEach(input => { input.value = value; });
  individualCheckboxes.forEach(cb => {
    if (cb.id && cb.id.startsWith('check-book-')) cb.checked = checked;
  });

  calculateTotal();
}

/* ==================================
   Sync checkbox <-> quantity input
   ================================== */
function updateQuantityAndCheckbox(element, type) {
  const index = element.getAttribute('data-index');
  const checkbox = document.getElementById(`check-book-${index}`);
  const qtyInput = document.getElementById(`qty-book-${index}`);
  const selectAllCheckbox = document.getElementById('select-all-books');

  if (!checkbox || !qtyInput) return;

  if (type === 'checkbox') {
    if (element.checked) qtyInput.value = 1; else qtyInput.value = 0;
  } else if (type === 'input') {
    let quantity = parseInt(element.value) || 0;
    if (quantity < 0) { quantity = 0; element.value = 0; }
    checkbox.checked = quantity > 0;
  }

  if (selectAllCheckbox) {
    const selectedClass = document.getElementById('class-select').value;
    const totalBooks = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass].length : 0;
    const checkedCount = Array.from(document.querySelectorAll('#books-list input[type="checkbox"]')).filter(cb => cb.id.startsWith('check-book-') && cb.checked).length;
    selectAllCheckbox.checked = (checkedCount === totalBooks && totalBooks > 0);
  }

  calculateTotal();
}

/* =======================
   Calculate totals display
   ======================= */
function calculateTotal() {
  const selectedClass = document.getElementById('class-select').value;
  if (!selectedClass) return;
  const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];
  let grandTotal = 0;

  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
  quantityInputs.forEach(input => {
    const index = input.getAttribute('data-index');
    const quantity = parseInt(input.value) || 0;
    const book = books[index];
    if (book) {
      const totalPrice = (Number(book.Price) || 0) * quantity;
      const el = document.getElementById(`book-${index}-total`);
      if (el) el.textContent = totalPrice.toLocaleString();
      grandTotal += totalPrice;
    }
  });

  const gt = document.getElementById('grand-total');
  if (gt) gt.textContent = grandTotal.toLocaleString() + ' BDT';
}

/* ============================================
   Generate memo, save data to sheet and print
   ============================================ */
function generateMemo() {
  calculateTotal();
  const selectedClass = document.getElementById('class-select').value;
  const memoOutput = document.getElementById('memo-output');

  const studentName = document.getElementById('student-name').value;
  const studentId = document.getElementById('student-id').value;

  if (!selectedClass) {
    alert('Please select a Class.');
    return;
  }

  let finalTotal = 0;
  const salesItems = [];
  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');

  const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];

  quantityInputs.forEach(input => {
    const quantity = parseInt(input.value) || 0;
    if (quantity > 0) {
      const index = input.getAttribute('data-index');
      const book = books[index];
      const price = Number(book.Price) || 0;
      const totalPrice = price * quantity;
      finalTotal += totalPrice;

      salesItems.push({
        Subject: book.Subject,
        Book: book.Books,
        Price: price,
        Qty: quantity,
        Total: totalPrice
      });
    }
  });

  if (salesItems.length === 0) {
    alert('Please check or enter a quantity for at least one book.');
    return;
  }

  // Generate Memo HTML
  let memoHTML = `
    <div class="memo-header">
      <h2>Book Sales Memo</h2>
      <p>Sales Date: <strong>${new Date().toLocaleDateString('en-US')}</strong></p>
      <p>Student Name: <strong>${studentName || 'N/A'}</strong></p>
      <p>Student ID: <strong>${studentId || 'N/A'}</strong></p>
      <p>Class: <strong>${selectedClass}</strong></p>
    </div>
    <table class="memo-table">
      <thead>
        <tr>
          <th>SL</th>
          <th>Book Name & Subject</th>
          <th style="text-align:right;">Unit Price (BDT)</th>
          <th style="text-align:center;">Qty</th>
          <th style="text-align:right;">Total Price (BDT)</th>
        </tr>
      </thead>
      <tbody>
  `;

  salesItems.forEach((item, i) => {
    memoHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(item.Book)} (${escapeHtml(item.Subject)})</td>
        <td style="text-align:right;">${item.Price.toLocaleString()}</td>
        <td style="text-align:center;">${item.Qty}</td>
        <td style="text-align:right;">${item.Total.toLocaleString()}</td>
      </tr>
    `;
  });

  memoHTML += `
      <tr class="total-row">
        <td colspan="4" style="text-align:right;">Grand Total Payable:</td>
        <td style="text-align:right;">${finalTotal.toLocaleString()} BDT</td>
      </tr>
    </tbody></table>
  `;

  memoOutput.innerHTML = memoHTML;
  memoOutput.style.display = 'block';

  // Save data to Google Sheet Web App (if you set SCRIPT_URL)
  const logData = {
    class: selectedClass,
    studentName: studentName,
    studentId: studentId,
    total: finalTotal,
    items: salesItems
  };
  logSaleToGoogleSheet(logData);

  // print
  window.print();
}

/* =================================================
   Send sale data to Google Apps Script Web App (POST)
   ================================================= */
function logSaleToGoogleSheet(data) {
  // Replace with your web app URL (Google Apps Script deploy as web app)
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBxbzsIcvRK_RDjn4VPiet2dWEaHb1vuLxY6Gtjt09rtd5YkwJXGbIFawdlBIVzcnm/exec';

  if (!SCRIPT_URL || !SCRIPT_URL.includes('https://script.google.com/macros/s/')) {
    console.warn('‚ö†Ô∏è Data saving is not possible. Please add your Google Apps Script Web App URL to the SCRIPT_URL variable.');
    return;
  }

  // Using no-cors mode (common for Apps Script endpoints set to allow anonymous POST)
  fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(() => console.log('‚úÖ Sales data sent to Google Sheet endpoint.'))
  .catch(err => console.error('‚ùå Error sending data to Google Sheet:', err));
}

/* ========
   Reset UI
   ======== */
function resetForm() {
  document.getElementById('class-select').value = '';
  document.getElementById('student-name').value = '';
  document.getElementById('student-id').value = '';
  document.getElementById('books-list').innerHTML = '';
  document.getElementById('memo-output').style.display = 'none';
}

/* Initialize global bookData container */
window.bookData = window.bookData || {};
</script>
</body>
</html>



