<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Book Sales Memo Generator</title>
    <style>
        /* =========================
           General Styles
           ========================= */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background-color: #f8f9fa; 
            color: #333; 
        }
        #app { 
            max-width: 950px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 20px 40px 40px 40px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.08); 
            border-top: 5px solid #007bff;
        }

        /* Banner Image Styling */
        .banner-img {
            width: 100%;
            height: auto;
            display: block;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        h1 { 
            text-align: center; 
            color: #007bff; 
            font-size: 1.8em;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Form Inputs */
        label { font-weight: 600; margin-bottom: 5px; display: block; color: #555; }
        
        select, input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 1em; 
            box-sizing: border-box; 
            transition: border-color 0.2s;
        }
        select:focus, input[type="text"]:focus {
            border-color: #80bdff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .form-row { margin-bottom: 20px; }
        
        .input-group { 
            display: flex; 
            gap: 20px; 
        }
        .input-group > div { flex: 1; }

        /* Buttons */
        .btn-group { margin-top: 25px; display: flex; gap: 10px; }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 1em; 
            font-weight: 600;
            transition: background-color .2s; 
        }
        .btn-generate { background-color: #28a745; color: white; flex-grow: 1;}
        .btn-generate:hover { background-color: #218838; }
        
        .btn-reset { background-color: #dc3545; color: white; }
        .btn-reset:hover { background-color: #c82333; }

        /* Table Styles */
        #books-list { margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #dee2e6; }
        .data-table th { background-color: #e9ecef; color: #495057; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; }
        .data-table td { padding: 10px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table input[type="number"] { width: 70px; padding: 5px; text-align: center; border: 1px solid #ced4da; border-radius: 4px; }
        
        /* Checkbox Styling */
        .data-table input[type="checkbox"] { transform: scale(1.2); margin-right: 8px; cursor: pointer; }
        #select-all-header { cursor: pointer; user-select: none; display: flex; align-items: center;}

        .total-row-display { font-weight: bold; color: #28a745; font-size: 1.1em; }

        /* Loader */
        .loader { display: inline-block; padding: 8px; color: #666; background: #f1f1f1; border-radius: 4px;}

        /* =========================
           Memo / Print Styles
           ========================= */
        .memo-container { 
            display: none; /* Hidden on screen until generated/printing logic kicks in */
            border: 1px solid #333; 
            padding: 20px;
        }

        @media print {
            /* Hide everything in #app EXCEPT the memo output */
            body > #app > *:not(#memo-output) { display: none !important; }
            
            body { margin: 0; background-color: white; }
            #app { 
                box-shadow: none; 
                border: none; 
                margin: 0; 
                padding: 0; 
                max-width: 100%; 
                width: 100%; 
            }

            #memo-output { 
                display: block !important; 
                width: 100%;
                margin: 0;
            }

            /* Memo Specific Print Styles */
            .memo-banner { width: 100%; height: auto; margin-bottom: 15px; }
            .memo-info { margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
            .memo-info p { margin: 4px 0; font-size: 14px; }
            .memo-info h2 { text-align: center; margin: 0 0 10px 0; text-transform: uppercase; font-size: 18px; }
            
            .memo-table { width: 100%; border-collapse: collapse; font-size: 12px; }
            .memo-table th, .memo-table td { border: 1px solid #000; padding: 6px; }
            .memo-table th { background-color: #f0f0f0; text-align: center; font-weight: bold; }
            .total-row { background-color: #f0f0f0; font-weight: bold; }
            
            /* Page Setup */
            @page { 
                size: A4; 
                margin: 10mm; 
                @bottom-left { content: "System Developed by NA Niloy"; font-size: 8pt; }
            }
        }
    </style>
</head>
<body>

    <div id="app">
        <img src="image.png" alt="Safeer Academy" class="banner-img" onerror="this.style.display='none'; alert('Ensure image.png is in the folder');">

        <h1>ðŸ“š Book Sales Memo Generator</h1>

        <div class="form-row">
            <label for="class-select">Select Class:</label>
            <select id="class-select" onchange="displayBooks()">
                <option value="">-- Select Class --</option>
            </select>
        </div>

        <div class="form-row input-group">
            <div>
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student's name (optional)">
            </div>
            <div>
                <label for="student-id">Student ID:</label>
                <input type="text" id="student-id" placeholder="Enter student's ID (optional)">
            </div>
        </div>

        <div id="books-list"></div>

        <div class="btn-group">
            <button class="btn-generate" onclick="generateMemo()">Generate Bill, Save Data, and Print</button>
            <button class="btn-reset" onclick="resetForm()">Create New Bill</button>
        </div>

        <div id="memo-output" class="memo-container"></div>
    </div>

<script>
/* =========================
   Sheet settings
   ========================= */
const SHEETS = [
  { name: "Nursery", gid: "489499898" },
  { name: "Reception", gid: "2027098770" },
  { name: "Year 1", gid: "1401175034" },
  { name: "Year 2", gid: "920652694" },
  { name: "Year 3", gid: "853416613" },
  { name: "Year 4", gid: "746344402" },
  { name: "Year 5", gid: "1210824589" },
  { name: "Year 6", gid: "863626512" },
  { name: "Year 7", gid: "790069678" },
  { name: "Year 8", gid: "622660697" },
  { name: "Year 9", gid: "2022019354" },
  { name: "Question Paper Set", gid: "596988486" }
];

const BASE = "https://docs.google.com/spreadsheets/d/1htWKKFov6IgbkJTqrhXl-EvvHzZlyWHOsNAQScfarw0/export?format=csv&gid=";

/* =========================
   CSV & Data Utilities
   ========================= */
function csvToRows(str) {
  str = str.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const rows = [];
  let cur = [];
  let field = '';
  let inQuotes = false;
  for (let i = 0; i < str.length; i++) {
    const ch = str[i];
    if (inQuotes) {
      if (ch === '"') {
        if (str[i+1] === '"') { field += '"'; i++; } else { inQuotes = false; }
      } else { field += ch; }
    } else {
      if (ch === '"') { inQuotes = true; } 
      else if (ch === ',') { cur.push(field); field = ''; } 
      else if (ch === '\n') { cur.push(field); field = ''; rows.push(cur); cur = []; } 
      else { field += ch; }
    }
  }
  if (field !== '' || inQuotes) cur.push(field);
  if (cur.length > 0) rows.push(cur);
  return rows;
}

function parseCSVToObjects(csvText) {
  const rows = csvToRows(csvText);
  if (!rows || rows.length === 0) return [];
  const headerRow = rows[0].map(h => (h || '').toString().trim());
  
  const map = { Subject: -1, Books: -1, Price: -1 };
  headerRow.forEach((h, idx) => {
    const key = (h || '').replace(/\s+/g, ' ').trim().toLowerCase();
    if (/^subject\b/i.test(h) || key.includes('subject')) map.Subject = idx;
    else if (/^books?\b/i.test(h) || key.includes('book')) map.Books = idx;
    else if (/^price\b/i.test(h) || key.includes('price') || key.includes('rate') || key.includes('unit')) map.Price = idx;
  });

  // Fallbacks
  if (map.Subject === -1 && headerRow.length >= 2) map.Subject = 1;
  if (map.Books === -1 && headerRow.length >= 3) map.Books = 2;
  if (map.Price === -1) map.Price = headerRow.length - 1;

  const data = [];
  for (let r = 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.every(c => (c || '').toString().trim() === '')) continue;
    const subject = (row[map.Subject] || '').toString().trim();
    const books = (row[map.Books] || '').toString().trim();
    let priceRaw = (row[map.Price] || '').toString().trim();
    priceRaw = priceRaw.replace(/[^0-9.\-]/g, '');
    const price = parseFloat(priceRaw) || 0;
    data.push({ Subject: subject || '-', Books: books || '-', Price: price });
  }
  return data;
}

/* =========================
   UI Logic
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('class-select');
  SHEETS.forEach(s => {
    const option = document.createElement('option');
    option.value = s.name;
    option.textContent = s.name;
    select.appendChild(option);
  });
});

async function loadBooksForClass(className) {
  const sheet = SHEETS.find(s => s.name === className);
  if (!sheet) return [];
  const url = BASE + sheet.gid;
  const booksListDiv = document.getElementById('books-list');
  
  booksListDiv.innerHTML = '<span class="loader">Loading data from Google Sheets...</span>';

  try {
    const resp = await fetch(url);
    if (!resp.ok) {
      booksListDiv.innerHTML = '<div style="color:red;">Failed to load sheet.</div>';
      return [];
    }
    const csv = await resp.text();
    return parseCSVToObjects(csv);
  } catch (err) {
    console.error('Error fetching sheet:', err);
    booksListDiv.innerHTML = '<div style="color:red;">Network Error.</div>';
    return [];
  }
}

async function displayBooks() {
  const selectedClass = document.getElementById('class-select').value;
  const booksListDiv = document.getElementById('books-list');
  booksListDiv.innerHTML = '';

  if (!selectedClass) return;

  const books = await loadBooksForClass(selectedClass);
  if (!books || books.length === 0) {
    if(booksListDiv.innerHTML.indexOf('Loading') === -1) booksListDiv.innerHTML = '<div style="color:#666;">No books found.</div>';
    window.bookData = window.bookData || {};
    window.bookData[selectedClass] = [];
    return;
  }

  let html = `
    <table class="data-table">
      <thead>
        <tr>
          <th width="25%">
            <div id="select-all-header" onclick="toggleSelectAll()">
              <input type="checkbox" id="select-all-books">
              <span>Subject (All)</span>
            </div>
          </th>
          <th width="40%">Book Name</th>
          <th width="15%">Price</th>
          <th width="10%">Qty</th>
          <th width="10%">Total</th>
        </tr>
      </thead>
      <tbody>
  `;

  books.forEach((book, index) => {
    const bookId = `book-${index}`;
    const priceDisplay = (typeof book.Price === 'number') ? book.Price.toLocaleString() : '0';
    html += `
      <tr id="${bookId}-row">
        <td>
          <input type="checkbox" id="check-book-${index}" data-index="${index}" onchange="updateRowFromCheck(this)">
          ${escapeHtml(book.Subject)}
        </td>
        <td>${escapeHtml(book.Books)}</td>
        <td class="unit-price">${priceDisplay}</td>
        <td>
          <input type="number" min="0" value="0" id="qty-book-${index}" data-index="${index}" oninput="updateRowFromInput(this)">
        </td>
        <td id="${bookId}-total">0</td>
      </tr>
    `;
  });

  html += `
      <tr>
        <td colspan="4" style="text-align:right; font-weight:bold;">Grand Total:</td>
        <td id="grand-total" class="total-row-display">0</td>
      </tr>
      </tbody>
    </table>
  `;

  booksListDiv.innerHTML = html;
  window.bookData = window.bookData || {};
  window.bookData[selectedClass] = books;
}

function escapeHtml(str) {
  return (str || '').toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

/* Interaction Logic */
function toggleSelectAll() {
    const masterCheck = document.getElementById('select-all-books');
    masterCheck.checked = !masterCheck.checked;
    const isChecked = masterCheck.checked;
    
    const checkboxes = document.querySelectorAll('#books-list input[type="checkbox"]');
    const quantities = document.querySelectorAll('#books-list input[type="number"]');
    
    checkboxes.forEach(cb => { if(cb !== masterCheck) cb.checked = isChecked; });
    quantities.forEach(qty => { qty.value = isChecked ? 1 : 0; });
    
    calculateTotal();
}

function updateRowFromCheck(checkbox) {
    const idx = checkbox.getAttribute('data-index');
    const qtyInput = document.getElementById(`qty-book-${idx}`);
    qtyInput.value = checkbox.checked ? 1 : 0;
    calculateTotal();
}

function updateRowFromInput(input) {
    const idx = input.getAttribute('data-index');
    const checkbox = document.getElementById(`check-book-${idx}`);
    const val = parseInt(input.value) || 0;
    checkbox.checked = (val > 0);
    calculateTotal();
}

function calculateTotal() {
    const selectedClass = document.getElementById('class-select').value;
    if (!selectedClass) return;
    const books = window.bookData[selectedClass] || [];
    let grandTotal = 0;

    const inputs = document.querySelectorAll('#books-list input[type="number"]');
    inputs.forEach(input => {
        const idx = input.getAttribute('data-index');
        const qty = parseInt(input.value) || 0;
        const price = Number(books[idx].Price) || 0;
        const rowTotal = qty * price;
        
        document.getElementById(`book-${idx}-total`).textContent = rowTotal.toLocaleString();
        grandTotal += rowTotal;
    });

    document.getElementById('grand-total').textContent = grandTotal.toLocaleString();
    
    // Update Select All state based on individual checks
    const allChecks = Array.from(document.querySelectorAll('input[type="checkbox"][id^="check-book-"]'));
    const masterCheck = document.getElementById('select-all-books');
    if(masterCheck && allChecks.length > 0) {
        masterCheck.checked = allChecks.every(c => c.checked);
    }
}

/* =========================
   Generate Memo & Print
   ========================= */
function generateMemo() {
    const selectedClass = document.getElementById('class-select').value;
    if (!selectedClass) { alert('Please select a class.'); return; }

    calculateTotal(); // Ensure totals are fresh

    const studentName = document.getElementById('student-name').value || "N/A";
    const studentId = document.getElementById('student-id').value || "N/A";
    const books = window.bookData[selectedClass] || [];
    
    const salesItems = [];
    let finalTotal = 0;

    const inputs = document.querySelectorAll('#books-list input[type="number"]');
    inputs.forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            const idx = input.getAttribute('data-index');
            const book = books[idx];
            const total = qty * (Number(book.Price) || 0);
            finalTotal += total;
            salesItems.push({ ...book, Qty: qty, Total: total });
        }
    });

    if (salesItems.length === 0) { alert('No books selected.'); return; }

    // Build Memo HTML - Includes the Banner Image tag for Print
    let memoHTML = `
        <img src="image.png" class="memo-banner" alt="Safeer Academy">
        
        <div class="memo-info">
            <h2>Book Sales Receipt</h2>
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <p><strong>Name:</strong> ${escapeHtml(studentName)}</p>
                    <p><strong>ID:</strong> ${escapeHtml(studentId)}</p>
                </div>
                <div style="text-align:right;">
                    <p><strong>Class:</strong> ${selectedClass}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
            </div>
        </div>

        <table class="memo-table">
            <thead>
                <tr>
                    <th width="5%">SL</th>
                    <th width="55%">Book Details</th>
                    <th width="15%">Unit Price</th>
                    <th width="10%">Qty</th>
                    <th width="15%">Total (BDT)</th>
                </tr>
            </thead>
            <tbody>
    `;

    salesItems.forEach((item, i) => {
        memoHTML += `
            <tr>
                <td style="text-align:center">${i+1}</td>
                <td>${escapeHtml(item.Books)} <br><small style="color:#555;">${escapeHtml(item.Subject)}</small></td>
                <td style="text-align:right">${item.Price.toLocaleString()}</td>
                <td style="text-align:center">${item.Qty}</td>
                <td style="text-align:right">${item.Total.toLocaleString()}</td>
            </tr>
        `;
    });

    memoHTML += `
            <tr class="total-row">
                <td colspan="4" style="text-align:right;"><strong>Grand Total</strong></td>
                <td style="text-align:right;"><strong>${finalTotal.toLocaleString()} BDT</strong></td>
            </tr>
        </tbody>
        </table>
    `;

    // Insert into container
    const memoDiv = document.getElementById('memo-output');
    memoDiv.innerHTML = memoHTML;
    
    // Send data to Google Sheet (Optional - requires Web App URL)
    const logData = {
        class: selectedClass,
        studentName: studentName,
        studentId: studentId,
        total: finalTotal,
        items: salesItems
    };
    logSaleToGoogleSheet(logData);

    // Trigger Print
    window.print();
}

function logSaleToGoogleSheet(data) {
  // Add your Script URL here if you have one
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBxbzsIcvRK_RDjn4VPiet2dWEaHb1vuLxY6Gtjt09rtd5YkwJXGbIFawdlBIVzcnm/exec';
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).catch(e => console.log('Data log error (expected if no-cors):', e));
}

function resetForm() {
    document.getElementById('class-select').value = '';
    document.getElementById('student-name').value = '';
    document.getElementById('student-id').value = '';
    document.getElementById('books-list').innerHTML = '';
    document.getElementById('memo-output').innerHTML = '';
}
</script>
</body>
</html>
