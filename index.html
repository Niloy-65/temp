<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Sales Memo Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        #app {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        label, select, button {
            display: block;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .input-group {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .input-group > div {
            flex: 1;
        }
        .input-group label {
            margin-bottom: 5px;
            font-size: 1em;
        }
        .input-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        button {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        #books-list {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .data-table th {
            background-color: #007bff;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Style for the checkbox */
        .data-table input[type="checkbox"] {
            transform: scale(1.2); 
            cursor: pointer;
            margin-right: 10px; 
            vertical-align: middle;
        }
        /* Style for the "Select All" control in the header */
        #select-all-header {
            display: flex;
            align-items: center;
            padding: 0; 
            margin: -10px; 
            padding: 10px;
            width: 100%; 
            height: 100%; 
        }
        /* Style the text part to be clickable */
        #select-all-text {
            cursor: pointer;
            padding: 5px; 
            margin-left: -5px; 
            flex-grow: 1;
        }
        #select-all-header:hover {
            background-color: #0069d9;
        }
        #select-all-header input[type="checkbox"] {
            margin-right: 5px;
        }

        /* Style for the number input */
        .data-table input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #fff3cd !important;
            color: #856404;
        }
        
        /* --- Print Memo Styles --- */
        .memo-container {
            border: 2px solid #333;
            padding: 30px;
            margin-top: 40px;
            display: none;
            max-width: 700px;
        }
        .memo-header {
            text-align: center;
            border-bottom: 3px double #333;
            margin-bottom: 10px; 
            padding-bottom: 5px; 
        }
        .memo-header h2 {
            margin: 0; 
            color: #333;
            font-size: 1.3em; 
        }
        .memo-header p {
            margin: 2px 0; 
            font-size: 1em; 
        }
        .memo-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; 
            font-size: 0.95em; 
        }
        .memo-table th, .memo-table td {
            border: 1px solid #999;
            padding: 6px 9px; 
            text-align: left;
        }
        .memo-table th {
            background-color: #e9ecef;
            font-size: 1em; 
        }
        .memo-table th:nth-child(1) { width: 5%; } 
        .memo-table th:nth-child(2) { width: 55%; } 
        .memo-table th:nth-child(3) { width: 15%; } 
        .memo-table th:nth-child(4) { width: 10%; } 
        .memo-table th:nth-child(5) { width: 15%; } 

        @media print {
            body > #app > *:not(.memo-container) { display: none !important; }
            .memo-container {
                display: block !important;
                border: none;
                padding: 0;
                margin: 0 auto;
                width: 100%;
                box-shadow: none;
            }
            .memo-header { 
                border-bottom: 3px double #333; 
                margin-bottom: 4mm; 
                padding-bottom: 2mm;
            }
            @page {
                size: A4;
                margin: 8mm 10mm 8mm 10mm; 
                @top-left { content: none; }
                @top-right { content: none; }
                @bottom-left { 
                    content: "System_Designed_&_Developed_by/NA_Niloy"; 
                    font-size: 8pt; 
                    color: #000000;   
                }
                @bottom-right { content: none; }
            }
        }
    </style>
</head>
<body>

    <div id="app">
        <h1>üìö Book Sales Memo Generator</h1>
        
        <label for="class-select">Select Class:</label>
        <select id="class-select" onchange="displayBooks()" disabled>
            <option value="">Initializing...</option>
        </select>

        <div class="input-group">
            <div>
                <label for="student-name">Student Name:</label>
                <input type="text" id="student-name" placeholder="Enter student's name (optional)">
            </div>
            <div>
                <label for="student-id">Student ID:</label>
                <input type="text" id="student-id" placeholder="Enter student's ID (optional)">
            </div>
        </div>
        <div id="books-list">
            </div>

        <button onclick="generateMemo()">Generate Bill, Save Data, and Print</button>
        <button onclick="resetForm()" style="background-color: #dc3545;">Create New Bill</button>

        <div id="memo-output" class="memo-container">
            </div>
    </div>

    <script>
        // --- 1. CONFIGURATION: Google Sheet Details ---
        const SHEET_ID = "1htWKKFov6IgbkJTqrhXl-EvvHzZlyWHOsNAQScfarw0"; // Your Spreadsheet ID
        const BASE_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_4TvT7tLnOIhy98JavbJEX5RBsv6a_2C-ATYhJKWhGXeGXztuFvBCoem0_C1WT0kbjb64OZKpN_fv/pub?output=csv&gid=`;

        // Map your Sheet Tabs to GIDs
        const SHEETS = [
            { name: "Nursery", gid: "2027098770" },
            { name: "Reception", gid: "1160595593" },
            { name: "Year 1", gid: "1401175034" },
            { name: "Year 2", gid: "1936279195" },
            { name: "Year 3", gid: "316633986" },
            { name: "Year 4", gid: "1739534263" },
            { name: "Year 5", gid: "17621944" },
            { name: "Year 6", gid: "1465173656" },
            { name: "Year 7", gid: "1305449456" },
            { name: "Year 8", gid: "230300680" },
            { name: "Year 9", gid: "1869557983" },
            { name: "Question Paper Set", gid: "1475934526" }
        ];

        // This variable will hold the data fetched from Google Sheets
        let bookData = {}; 

        // --- 2. Fetch Data on Startup ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchBooksFromGoogleSheet();
        });

        async function fetchBooksFromGoogleSheet() {
            const select = document.getElementById('class-select');
            select.innerHTML = '<option value="">Loading data from Google Sheets...</option>';
            
            try {
                // Fetch all sheets in parallel
                const promises = SHEETS.map(async (sheet) => {
                    const response = await fetch(BASE_URL + sheet.gid);
                    if (!response.ok) throw new Error(`Failed to load ${sheet.name}`);
                    const csvText = await response.text();
                    bookData[sheet.name] = parseCSV(csvText);
                });

                await Promise.all(promises);

                // Data loaded successfully
                populateDropdown();
                console.log("‚úÖ All book data loaded successfully");

            } catch (error) {
                console.error("‚ùå Error fetching data:", error);
                select.innerHTML = '<option value="">Error loading data. Check console.</option>';
                alert("Failed to load book data from Google Sheets. Please check your internet connection and Sheet permissions.");
            }
        }

        // --- Helper: Parse CSV to JSON ---
        function parseCSV(csvText) {
            const rows = csvText.split('\n').filter(row => row.trim() !== '');
            // Remove header row (index 0)
            const dataRows = rows.slice(1); 
            
            return dataRows.map(row => {
                // Regex to handle commas inside quotes
                const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                
                // Clean up quotes if present
                const clean = (text) => text ? text.replace(/^"|"$/g, '').trim() : '';

                // Ensure we have at least 3 columns, otherwise return null
                if(cols.length < 3) return null;

                return {
                    "Subject": clean(cols[0]), // Column A
                    "Books": clean(cols[1]),   // Column B
                    "Price": parseFloat(clean(cols[2])) || 0 // Column C
                };
            }).filter(item => item !== null); // Filter out empty/malformed rows
        }

        // --- 3. Populate Dropdown ---
        function populateDropdown() {
            const select = document.getElementById('class-select');
            select.innerHTML = '<option value="">-- Select Class --</option>'; // Reset
            select.disabled = false;

            SHEETS.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.name;
                option.textContent = sheet.name;
                select.appendChild(option);
            });
        }

        // --- 4. Display Books ---
        function displayBooks() {
            const selectedClass = document.getElementById('class-select').value;
            const booksListDiv = document.getElementById('books-list');
            booksListDiv.innerHTML = '';
            
            if (!selectedClass || !bookData[selectedClass]) return;

            const books = bookData[selectedClass];
            let html = '<h3>Book List for ' + selectedClass + ' Class</h3>';
            
            html += '<table class="data-table"><thead><tr>';
            
            html += `
                <th>
                    <div id="select-all-header">
                        <input type="checkbox" id="select-all-books" onchange="selectAllBooks(this.checked)">
                        <span id="select-all-text" onclick="document.getElementById('select-all-books').click()">
                            Subject (Select All)
                        </span>
                    </div>
                </th>
            `;
            
            html += '<th>Book Name</th><th>Unit Price (BDT)</th><th>Quantity</th><th>Total Price (BDT)</th></tr></thead><tbody>';

            books.forEach((book, index) => {
                const bookId = `book-${index}`;
                html += `
                    <tr id="${bookId}-row">
                        <td>
                            <input type="checkbox" id="check-${bookId}" data-index="${index}" onchange="updateQuantityAndCheckbox(this, 'checkbox')">
                            ${book.Subject}
                        </td>
                        <td>${book.Books}</td>
                        <td class="unit-price" data-price="${book.Price}">${book.Price.toLocaleString()}</td>
                        <td>
                            <input type="number" min="0" value="0" id="qty-${bookId}" data-index="${index}" oninput="updateQuantityAndCheckbox(this, 'input')">
                        </td>
                        <td id="${bookId}-total">0</td>
                    </tr>
                `;
            });

            html += '<tr><td colspan="4" style="text-align: right;">Grand Total:</td><td id="grand-total" class="total-row">0</td></tr>';
            html += '</tbody></table>';
            
            booksListDiv.innerHTML = html;
        }
        
        // --- 5. Select/Deselect All ---
        function selectAllBooks(checked) {
            const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
            const individualCheckboxes = document.querySelectorAll('#books-list input[type="checkbox"]');
            
            const value = checked ? 1 : 0;
            
            quantityInputs.forEach(input => {
                input.value = value;
            });
            individualCheckboxes.forEach(cb => {
                if (cb.id.startsWith('check-book-')) {
                    cb.checked = checked;
                }
            });
            
            calculateTotal();
        }

        // --- 6. Sync Checkbox and Quantity ---
        function updateQuantityAndCheckbox(element, type) {
            const index = element.getAttribute('data-index');
            const checkbox = document.getElementById(`check-book-${index}`);
            const qtyInput = document.getElementById(`qty-book-${index}`);
            const selectAllCheckbox = document.getElementById('select-all-books');
            
            if (!checkbox || !qtyInput) return;

            if (type === 'checkbox') {
                qtyInput.value = element.checked ? 1 : 0;
            } else if (type === 'input') {
                let quantity = parseInt(element.value) || 0;
                if (quantity < 0) { quantity = 0; element.value = 0; }
                checkbox.checked = quantity > 0;
            }
            
            // Update "Select All" state
            const selectedClass = document.getElementById('class-select').value;
            if (selectedClass && selectAllCheckbox && bookData[selectedClass]) {
                const totalBooks = bookData[selectedClass].length;
                const checkedCount = Array.from(document.querySelectorAll('#books-list input[type="checkbox"]'))
                    .filter(cb => cb.id.startsWith('check-book-') && cb.checked).length;
                
                selectAllCheckbox.checked = (checkedCount === totalBooks);
            }

            calculateTotal();
        }

        // --- 7. Calculate Total ---
        function calculateTotal() {
            const selectedClass = document.getElementById('class-select').value;
            if (!selectedClass || !bookData[selectedClass]) return;

            const books = bookData[selectedClass];
            let grandTotal = 0;
            
            const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');

            quantityInputs.forEach(input => {
                const index = input.getAttribute('data-index');
                const quantity = parseInt(input.value) || 0;
                const book = books[index];
                
                if (book) {
                    const totalPrice = book.Price * quantity;
                    document.getElementById(`book-${index}-total`).textContent = totalPrice.toLocaleString();
                    grandTotal += totalPrice;
                }
            });

            document.getElementById('grand-total').textContent = grandTotal.toLocaleString() + ' BDT';
        }
        
        // --- 8. Generate Memo & Save ---
        function generateMemo() {
            calculateTotal(); 
            const selectedClass = document.getElementById('class-select').value;
            const memoOutput = document.getElementById('memo-output');
            
            const studentName = document.getElementById('student-name').value;
            const studentId = document.getElementById('student-id').value;

            if (!selectedClass) {
                alert('Please select a Class.');
                return;
            }
            
            let finalTotal = 0;
            const salesItems = [];

            const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
            
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const index = input.getAttribute('data-index');
                    const book = bookData[selectedClass][index]; 
                    const totalPrice = book.Price * quantity;
                    finalTotal += totalPrice;
                    
                    salesItems.push({
                        Subject: book.Subject,
                        Book: book.Books,
                        Price: book.Price,
                        Qty: quantity,
                        Total: totalPrice
                    });
                }
            });

            if (salesItems.length === 0) {
                alert('Please check or enter a quantity for at least one book.');
                return;
            }

            // --- Generate Memo HTML ---
            let memoHTML = `
                <div class="memo-header">
                    <h2>Book Sales Memo</h2>
                    <p>Sales Date: <strong>${new Date().toLocaleDateString('en-US')}</strong></p>
                    <p>Student Name: <strong>${studentName || 'N/A'}</strong></p>
                    <p>Student ID: <strong>${studentId || 'N/A'}</strong></p>
                    <p>Class: <strong>${selectedClass}</strong></p>
                </div>
                <table class="memo-table">
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>Book Name & Subject</th>
                            <th style="text-align: right;">Unit Price (BDT)</th>
                            <th style="text-align: center;">Qty</th>
                            <th style="text-align: right;">Total Price (BDT)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            salesItems.forEach((item, index) => {
                memoHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.Book} (${item.Subject})</td>
                        <td style="text-align: right;">${item.Price.toLocaleString()}</td>
                        <td style="text-align: center;">${item.Qty}</td>
                        <td style="text-align: right;">${item.Total.toLocaleString()}</td>
                    </tr>
                `;
            });

            memoHTML += `
                <tr class="total-row">
                    <td colspan="4" style="text-align: right;">Grand Total Payable:</td>
                    <td style="text-align: right;">${finalTotal.toLocaleString()} BDT</td>
                </tr>
            </tbody>
            </table>
            `;

            memoOutput.innerHTML = memoHTML;
            memoOutput.style.display = 'block';

            const logData = {
                class: selectedClass,
                studentName: studentName,
                studentId: studentId,
                total: finalTotal,
                items: salesItems
            };
            logSaleToGoogleSheet(logData);
            
            window.print();
        }

        // --- 9. Save to Google Sheet (Backend Logging) ---
        function logSaleToGoogleSheet(data) {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBxbzsIcvRK_RDjn4VPiet2dWEaHb1vuLxY6Gtjt09rtd5YkwJXGbIFawdlBIVzcnm/exec'; 
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => console.log('‚úÖ Sales data sent.'))
            .catch(error => console.error('‚ùå Error sending data:', error));
        }

        // --- 10. Reset Form ---
        function resetForm() {
            document.getElementById('class-select').value = '';
            document.getElementById('student-name').value = '';
            document.getElementById('student-id').value = '';
            document.getElementById('books-list').innerHTML = '';
            document.getElementById('memo-output').style.display = 'none';
        }
    </script>
</body>
</html>