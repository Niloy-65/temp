<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Book Sales Memo Generator</title>
    <style>
        /* ---------- Page / Card ---------- */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #eef1f6;
            color: #333;
        }
        .page-wrapper {
            max-width: 1100px;
            margin: 0 auto;
            padding: 18px;
        }
        #app {
            background: #fff;
            padding: 26px;
            border-radius: 10px;
            box-shadow: 0 10px 24px rgba(18, 38, 63, 0.08);
            border: 1px solid rgba(0,0,0,0.04);
        }

        /* ---------- Banner ---------- */
        .banner-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 0 18px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 18px;
        }
        .banner {
            max-width: 100%;
            width: 100%;
            height: 110px;
            object-fit: contain;
            display: block;
        }

        /* ---------- Title area (with icon) ---------- */
        .title-row {
            display:flex;
            align-items:center;
            justify-content:center;
            gap:12px;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 18px;
        }
        .title-row .icon {
            font-size: 40px;
            line-height: 1;
        }
        .title-row h1 {
            margin: 0;
            font-size: 30px;
            color: #0b77e8;
            font-weight: 700;
            text-shadow: 0 1px 0 rgba(255,255,255,0.6);
        }

        /* ---------- Form / inputs ---------- */
        label, select, button { display:block; margin-bottom: 8px; font-size: 1.05em; }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            align-items: end;
        }
        select { width: 100%; padding: 10px; border: 1px solid #d1d7e0; border-radius: 6px; box-sizing: border-box; background: #fff; }
        .input-group { display:flex; gap:20px; margin-top:15px; margin-bottom:10px; }
        .input-group>div { flex:1; }
        .input-group label { margin-bottom:5px; font-size:1em; }
        .input-group input[type="text"] { width:100%; padding:10px; border:1px solid #d1d7e0; border-radius:6px; font-size:1em; box-sizing:border-box; background:#fff; }

        /* ---------- Buttons ---------- */
        .actions {
            margin-top: 14px;
            display:flex;
            gap:12px;
            align-items:center;
            flex-wrap:wrap;
        }
        .btn {
            display:inline-block;
            padding:12px 18px;
            border-radius:6px;
            color:#fff;
            border:none;
            cursor:pointer;
            font-size:15px;
            font-weight:600;
            box-shadow: 0 6px 14px rgba(11,119,232,0.08);
        }
        .btn-green { background:#28a745; }
        .btn-green:hover { background:#218838; }
        .btn-red { background:#dc3545; }
        .btn-red:hover { background:#c82333; }

        /* ---------- Books list table ---------- */
        #books-list { margin-top:18px; padding:12px; border:1px solid #eee; border-radius:8px; min-height:40px; background:#fff; }
        .data-table { width:100%; border-collapse: collapse; margin-top:12px; font-size:0.95em; }
        .data-table th, .data-table td { border:1px solid #f0f0f6; padding:10px; text-align:left; vertical-align: middle; }
        .data-table th { background:#0b77e8; color:#fff; font-weight:700; }
        .data-table tr:nth-child(even) { background:#fbfcff; }
        .data-table input[type="checkbox"] { transform:scale(1.15); cursor:pointer; margin-right:8px; }
        .data-table input[type="number"] { width:70px; padding:6px; text-align:center; border:1px solid #d5dbe6; border-radius:4px; }

        .total-row { font-weight:700; background:#fff3cd !important; color:#856404; }

        /* ---------- Memo / Print styles ---------- */
        .memo-container { border:2px solid #333; padding:24px; margin-top:26px; display:none; max-width:760px; margin-left:auto; margin-right:auto; }
        .memo-header { text-align:center; border-bottom:3px double #333; margin-bottom:10px; padding-bottom:8px; }
        .memo-header img.banner-memo { max-width:100%; height:95px; object-fit:contain; display:block; margin:0 auto 6px auto; }
        .memo-table { width:100%; border-collapse: collapse; margin-top:10px; font-size:0.95em; }
        .memo-table th, .memo-table td { border:1px solid #999; padding:6px 9px; text-align:left; }
        .memo-table th { background:#e9ecef; font-size:1em; }

        /* Loader */
        .loader { display:inline-block; padding:4px 8px; background:#eef3fb; border-radius:6px; font-size:.9em; color:#0b77e8; margin-left:8px; }

        /* Responsive */
        @media (max-width: 900px) {
            .controls { grid-template-columns: 1fr; }
            .title-row h1 { font-size:24px; }
            .banner { height:80px; }
        }

        /* Print rules - show memo only */
        @media print {
            body { background: #fff; }
            body > .page-wrapper > *:not(.memo-container) { display: none !important; }
            .memo-container { display:block !important; border:none; padding:0; margin:0 auto; width:100%; box-shadow:none; }
            .memo-header { border-bottom:3px double #333; margin-bottom:4mm; padding-bottom:2mm; }
            @page { size: A4; margin: 8mm 10mm 8mm 10mm;
                @bottom-left { content: "System_Designed_&_Developed_by/NA_Niloy"; font-size:8pt; color:#000000; }
                @bottom-right { content:none; }
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div id="app">
            <!-- Banner (image.png must be in same folder) -->
            <div class="banner-wrap">
                <img src="image.png" alt="School Banner" class="banner">
            </div>

            <!-- Title with icon like your design -->
            <div class="title-row" role="banner" aria-label="Page title">
                <div class="icon">üìö</div>
                <h1>Book Sales Memo Generator</h1>
            </div>

            <!-- Controls area -->
            <div class="controls" aria-label="Controls">
                <div>
                    <label for="class-select">Select Class:</label>
                    <select id="class-select" onchange="displayBooks()">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>

                <div>
                    <label for="student-name">Student Name:</label>
                    <input type="text" id="student-name" placeholder="Enter student's name (optional)">
                </div>

                <div>
                    <label for="student-id">Student ID:</label>
                    <input type="text" id="student-id" placeholder="Enter student's ID (optional)">
                </div>
            </div>

            <div id="books-list" aria-live="polite"></div>

            <div class="actions">
                <button class="btn btn-green" onclick="generateMemo()">Generate Bill, Save Data, and Print</button>
                <button class="btn btn-red" onclick="resetForm()">Create New Bill</button>
            </div>

            <div id="memo-output" class="memo-container" role="region" aria-label="Generated memo"></div>
        </div>
    </div>

<script>
/* =========================
   Sheet settings (edit these)
   ========================= */
const SHEETS = [
  { name: "Nursery", gid: "489499898" },
  { name: "Reception", gid: "2027098770" },
  { name: "Year 1", gid: "1401175034" },
  { name: "Year 2", gid: "920652694" },
  { name: "Year 3", gid: "853416613" },
  { name: "Year 4", gid: "746344402" },
  { name: "Year 5", gid: "1210824589" },
  { name: "Year 6", gid: "863626512" },
  { name: "Year 7", gid: "790069678" },
  { name: "Year 8", gid: "622660697" },
  { name: "Year 9", gid: "2022019354" },
  { name: "Question Paper Set", gid: "596988486" }
];

// correct CSV base (your sheet)
const BASE = "https://docs.google.com/spreadsheets/d/1htWKKFov6IgbkJTqrhXl-EvvHzZlyWHOsNAQScfarw0/export?format=csv&gid=";

/* =========
   Utilities
   ========= */

/* Robust CSV parser that handles quoted fields and commas inside quoted fields */
function csvToRows(str) {
  str = str.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const rows = [];
  let cur = [];
  let field = '';
  let inQuotes = false;
  for (let i = 0; i < str.length; i++) {
    const ch = str[i];
    if (inQuotes) {
      if (ch === '"') {
        if (str[i+1] === '"') { field += '"'; i++; } else { inQuotes = false; }
      } else { field += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { cur.push(field); field = ''; }
      else if (ch === '\n') { cur.push(field); field = ''; rows.push(cur); cur = []; }
      else { field += ch; }
    }
  }
  if (field !== '' || inQuotes) { cur.push(field); }
  if (cur.length > 0) rows.push(cur);
  return rows;
}

/* Parse CSV text into objects, detect headers (ignores SL. column) */
function parseCSVToObjects(csvText) {
  const rows = csvToRows(csvText);
  if (!rows || rows.length === 0) return [];
  const headerRow = rows[0].map(h => (h || '').toString().trim());
  const map = { Subject: -1, Books: -1, Price: -1 };
  headerRow.forEach((h, idx) => {
    const key = (h || '').replace(/\s+/g, ' ').trim().toLowerCase();
    if (/^subject\b/i.test(h) || key.includes('subject')) map.Subject = idx;
    else if (/^books?\b/i.test(h) || key.includes('book')) map.Books = idx;
    else if (/^price\b/i.test(h) || key.includes('price') || key.includes('rate') || key.includes('unit')) map.Price = idx;
  });
  if (map.Subject === -1) {
    headerRow.forEach((h, idx) => { if (/(subject|sub)/i.test(h) && map.Subject === -1) map.Subject = idx; });
  }
  if (map.Books === -1) {
    headerRow.forEach((h, idx) => { if (/(book|title)/i.test(h) && map.Books === -1) map.Books = idx; });
  }
  if (map.Price === -1) {
    headerRow.forEach((h, idx) => { if (/(price|rate|unit)/i.test(h) && map.Price === -1) map.Price = idx; });
  }
  if (map.Subject === -1 && headerRow.length >= 2) map.Subject = 1;
  if (map.Books === -1 && headerRow.length >= 3) map.Books = 2;
  if (map.Price === -1) map.Price = headerRow.length - 1;

  const data = [];
  for (let r = 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.every(c => (c || '').toString().trim() === '')) continue;
    const subject = (row[map.Subject] || '').toString().trim();
    const books = (row[map.Books] || '').toString().trim();
    let priceRaw = (row[map.Price] || '').toString().trim();
    priceRaw = priceRaw.replace(/[^0-9.\-]/g, '');
    const price = parseFloat(priceRaw) || 0;
    data.push({ Subject: subject || '-', Books: books || '-', Price: price });
  }
  return data;
}

/* ===== DOM binding ===== */
document.addEventListener('DOMContentLoaded', () => {
  const select = document.getElementById('class-select');
  SHEETS.forEach(s => {
    const option = document.createElement('option');
    option.value = s.name;
    option.textContent = s.name;
    select.appendChild(option);
  });
});

/* =========================
   Load CSV from Google Sheet
   ========================= */
async function loadBooksForClass(className) {
  const sheet = SHEETS.find(s => s.name === className);
  if (!sheet) return [];
  const url = BASE + sheet.gid;

  const booksListDiv = document.getElementById('books-list');
  const loader = document.createElement('span');
  loader.className = 'loader';
  loader.textContent = 'Loading...';
  booksListDiv.innerHTML = '';
  booksListDiv.appendChild(loader);

  try {
    const resp = await fetch(url);
    if (!resp.ok) {
      console.warn('Fetch failed status:', resp.status);
      booksListDiv.innerHTML = '<div style="color:#a00;">Failed to load sheet (check sharing/public access).</div>';
      return [];
    }
    const csv = await resp.text();
    const items = parseCSVToObjects(csv);
    return items;
  } catch (err) {
    console.error('Error fetching sheet:', err);
    booksListDiv.innerHTML = '<div style="color:#a00;">Error fetching sheet data. See console.</div>';
    return [];
  }
}

/* ============================
   Display books using sheet data
   ============================ */
async function displayBooks() {
  const selectedClass = document.getElementById('class-select').value;
  const booksListDiv = document.getElementById('books-list');
  booksListDiv.innerHTML = '';

  if (!selectedClass) return;

  const books = await loadBooksForClass(selectedClass);
  if (!books || books.length === 0) {
    booksListDiv.innerHTML = '<div style="color:#555;">No books found in sheet for this class.</div>';
    window.bookData = window.bookData || {};
    window.bookData[selectedClass] = [];
    return;
  }

  let html = `<h3 style="margin:6px 0 0 0;">Book List for ${selectedClass}</h3>`;
  html += `
    <table class="data-table" role="table" aria-label="Books list">
      <thead>
        <tr>
          <th>
            <div id="select-all-header">
              <input type="checkbox" id="select-all-books" onchange="selectAllBooks(this.checked)">
              <span id="select-all-text" onclick="document.getElementById('select-all-books').click()"> Subject (Select All) </span>
            </div>
          </th>
          <th>Book Name</th>
          <th>Unit Price (BDT)</th>
          <th>Quantity</th>
          <th>Total Price (BDT)</th>
        </tr>
      </thead>
      <tbody>
  `;

  books.forEach((book, index) => {
    const bookId = `book-${index}`;
    const priceDisplay = (typeof book.Price === 'number') ? book.Price.toLocaleString() : (book.Price || '0');
    html += `
      <tr id="${bookId}-row">
        <td>
          <input type="checkbox" id="check-book-${index}" data-index="${index}" onchange="updateQuantityAndCheckbox(this, 'checkbox')">
          ${escapeHtml(book.Subject)}
        </td>
        <td>${escapeHtml(book.Books)}</td>
        <td class="unit-price" data-price="${book.Price}">${priceDisplay}</td>
        <td>
          <input type="number" min="0" value="0" id="qty-book-${index}" data-index="${index}" oninput="updateQuantityAndCheckbox(this, 'input')">
        </td>
        <td id="${bookId}-total">0</td>
      </tr>
    `;
  });

  html += `
      <tr>
        <td colspan="4" style="text-align:right;">Grand Total:</td>
        <td id="grand-total" class="total-row">0</td>
      </tr>
      </tbody>
    </table>
  `;

  booksListDiv.innerHTML = html;
  window.bookData = window.bookData || {};
  window.bookData[selectedClass] = books;
}

/* small escape helper */
function escapeHtml(str) {
  if (!str) return '';
  return str.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

/* =========================
   Select/deselect & sync
   ========================= */
function selectAllBooks(checked) {
  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
  const individualCheckboxes = document.querySelectorAll('#books-list input[type="checkbox"]');
  const value = checked ? 1 : 0;
  quantityInputs.forEach(input => { input.value = value; });
  individualCheckboxes.forEach(cb => {
    if (cb.id && cb.id.startsWith('check-book-')) cb.checked = checked;
  });
  calculateTotal();
}

function updateQuantityAndCheckbox(element, type) {
  const index = element.getAttribute('data-index');
  const checkbox = document.getElementById(`check-book-${index}`);
  const qtyInput = document.getElementById(`qty-book-${index}`);
  const selectAllCheckbox = document.getElementById('select-all-books');
  if (!checkbox || !qtyInput) return;

  if (type === 'checkbox') {
    if (element.checked) qtyInput.value = 1; else qtyInput.value = 0;
  } else if (type === 'input') {
    let quantity = parseInt(element.value) || 0;
    if (quantity < 0) { quantity = 0; element.value = 0; }
    checkbox.checked = quantity > 0;
  }

  if (selectAllCheckbox) {
    const selectedClass = document.getElementById('class-select').value;
    const totalBooks = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass].length : 0;
    const checkedCount = Array.from(document.querySelectorAll('#books-list input[type="checkbox"]'))
      .filter(cb => cb.id.startsWith('check-book-') && cb.checked).length;
    selectAllCheckbox.checked = (checkedCount === totalBooks && totalBooks > 0);
  }

  calculateTotal();
}

/* =======================
   Calculate totals
   ======================= */
function calculateTotal() {
  const selectedClass = document.getElementById('class-select').value;
  if (!selectedClass) return;
  const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];
  let grandTotal = 0;
  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
  quantityInputs.forEach(input => {
    const index = input.getAttribute('data-index');
    const quantity = parseInt(input.value) || 0;
    const book = books[index];
    if (book) {
      const totalPrice = (Number(book.Price) || 0) * quantity;
      const el = document.getElementById(`book-${index}-total`);
      if (el) el.textContent = totalPrice.toLocaleString();
      grandTotal += totalPrice;
    }
  });

  const gt = document.getElementById('grand-total');
  if (gt) gt.textContent = grandTotal.toLocaleString() + ' BDT';
}

/* ============================================
   Generate memo (includes banner image) & save
   ============================================ */
function generateMemo() {
  calculateTotal();
  const selectedClass = document.getElementById('class-select').value;
  const memoOutput = document.getElementById('memo-output');
  const studentName = document.getElementById('student-name').value;
  const studentId = document.getElementById('student-id').value;
  if (!selectedClass) { alert('Please select a Class.'); return; }

  let finalTotal = 0;
  const salesItems = [];
  const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
  const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];
  quantityInputs.forEach(input => {
    const quantity = parseInt(input.value) || 0;
    if (quantity > 0) {
      const index = input.getAttribute('data-index');
      const book = books[index];
      const price = Number(book.Price) || 0;
      const totalPrice = price * quantity;
      finalTotal += totalPrice;
      salesItems.push({ Subject: book.Subject, Book: book.Books, Price: price, Qty: quantity, Total: totalPrice });
    }
  });

  if (salesItems.length === 0) { alert('Please check or enter a quantity for at least one book.'); return; }

  // MEMO HTML (includes banner image)
  let memoHTML = `
    <div class="memo-header">
      <img class="banner-memo" src="image.png" alt="School Banner">
      <h2>Book Sales Memo</h2>
      <p>Sales Date: <strong>${new Date().toLocaleDateString('en-US')}</strong></p>
      <p>Student Name: <strong>${studentName || 'N/A'}</strong> &nbsp;&nbsp; Student ID: <strong>${studentId || 'N/A'}</strong></p>
      <p>Class: <strong>${selectedClass}</strong></p>
    </div>
    <table class="memo-table" role="table" aria-label="Sales items">
      <thead>
        <tr>
          <th>SL</th>
          <th>Book Name & Subject</th>
          <th style="text-align:right;">Unit Price (BDT)</th>
          <th style="text-align:center;">Qty</th>
          <th style="text-align:right;">Total Price (BDT)</th>
        </tr>
      </thead>
      <tbody>
  `;

  salesItems.forEach((item, i) => {
    memoHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${escapeHtml(item.Book)} (${escapeHtml(item.Subject)})</td>
        <td style="text-align:right;">${item.Price.toLocaleString()}</td>
        <td style="text-align:center;">${item.Qty}</td>
        <td style="text-align:right;">${item.Total.toLocaleString()}</td>
      </tr>
    `;
  });

  memoHTML += `
      <tr class="total-row">
        <td colspan="4" style="text-align:right;">Grand Total Payable:</td>
        <td style="text-align:right;">${finalTotal.toLocaleString()} BDT</td>
      </tr>
      </tbody></table>
  `;

  memoOutput.innerHTML = memoHTML;
  memoOutput.style.display = 'block';

  // Save to Google Apps Script Web App if configured
  const logData = { class: selectedClass, studentName, studentId, total: finalTotal, items: salesItems };
  logSaleToGoogleSheet(logData);

  // Print
  window.print();
}

/* =================================================
   Send sale data to Google Apps Script Web App (POST)
   ================================================= */
function logSaleToGoogleSheet(data) {
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBxbzsIcvRK_RDjn4VPiet2dWEaHb1vuLxY6Gtjt09rtd5YkwJXGbIFawdlBIVzcnm/exec';
  if (!SCRIPT_URL || !SCRIPT_URL.includes('https://script.google.com/macros/s/')) {
    console.warn('‚ö†Ô∏è Data saving is not possible. Please add your Google Apps Script Web App URL to the SCRIPT_URL variable.');
    return;
  }
  fetch(SCRIPT_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(() => console.log('‚úÖ Sales data sent to Google Sheet endpoint.'))
  .catch(err => console.error('‚ùå Error sending data to Google Sheet:', err));
}

/* ========
   Reset UI
   ======== */
function resetForm() {
  document.getElementById('class-select').value = '';
  document.getElementById('student-name').value = '';
  document.getElementById('student-id').value = '';
  document.getElementById('books-list').innerHTML = '';
  document.getElementById('memo-output').style.display = 'none';
}

/* Initialize global bookData container */
window.bookData = window.bookData || {};
</script>
</body>
</html>
