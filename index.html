<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Sales Memo Generator</title>
  <style>
    /* ====== Page layout ====== */
    :root {
      --primary: #007bff;
      --accent: #ff7a00;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --surface: #f4f4f9;
    }
    html,body { height:100%; }
    body {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 18px;
      background: var(--surface);
      color: #333;
      -webkit-font-smoothing:antialiased;
    }

    /* Outer card */
    #app {
      max-width: 1080px;
      margin: 16px auto;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* Banner (image across top) */
    .banner {
      display:flex;
      align-items:center;
      justify-content:center;
      background: #fff;
      padding: 18px 20px;
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    .banner img {
      max-width: 100%;
      height: auto;
      object-fit: contain;
      display:block;
    }

    /* Header title area */
    .page-head {
      padding: 20px 36px;
      text-align:center;
      border-bottom: 1px solid #eef2f6;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.9));
    }
    .page-head h1 {
      margin: 6px 0 2px 0;
      color: var(--primary);
      font-size: 32px;
      letter-spacing: -0.5px;
    }
    .page-head p.lead {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* Form content */
    .content {
      padding: 20px 36px 36px 36px;
    }
    label { font-weight:600; color:#444; display:block; margin-bottom:8px; }
    select, input[type="text"], input[type="number"] {
      width:100%;
      padding:10px 12px;
      border:1px solid #d9dfe6;
      border-radius:6px;
      box-sizing:border-box;
      font-size:14px;
      background: #fff;
    }

    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:18px;
      align-items:end;
    }

    .input-group {
      display:flex;
      gap:20px;
      margin-top:16px;
      margin-bottom:10px;
    }
    .input-group > div { flex:1; }

    /* Buttons row */
    .actions {
      margin-top:18px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:12px 18px;
      border-radius:8px;
      font-size:15px;
      cursor:pointer;
      border:none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    .btn.primary { background:#28a745; color:#fff; }
    .btn.primary:hover { background:#218838; }
    .btn.danger { background:#dc3545; color:#fff; }
    .btn.ghost { background:transparent; color:var(--muted); border:1px solid #e6e9ed; }

    /* Books list table */
    #books-list { margin-top:20px; padding:10px 6px; border-radius:8px; }
    .data-table { width:100%; border-collapse: collapse; margin-top:8px; font-size:14px; }
    .data-table th, .data-table td { border:1px solid #f0f2f5; padding:10px 12px; vertical-align:middle; text-align:left; }
    .data-table th { background:#f7f9fb; color:#2b2b2b; font-weight:700; font-size:14px; }
    .data-table tr:nth-child(even){ background:#fbfbfd; }
    .data-table input[type="number"] { width:72px; padding:6px 8px; border-radius:6px; border:1px solid #e1e6ea; text-align:center; }
    .data-table input[type="checkbox"] { transform:scale(1.1); margin-right:8px; }

    .total-row { font-weight:700; background:#fff8db; color:#5e4b00; }

    /* Memo container (print area) */
    .memo-container {
      border:2px solid #333;
      padding:28px 26px;
      margin:36px auto;
      display:none;
      max-width:740px;
      background:#fff;
      border-radius:6px;
      box-shadow:0 8px 30px rgba(0,0,0,0.04);
    }
    .memo-header { text-align:center; border-bottom:3px double #333; margin-bottom:12px; padding-bottom:10px; }
    .memo-header img { max-height:72px; object-fit:contain; margin-bottom:6px; display:block; margin-left:auto; margin-right:auto; }
    .memo-header h2 { margin:2px 0; font-size:20px; color:#222; }
    .memo-header p { margin:1px 0; font-size:13px; color:#333; }

    .memo-table { width:100%; border-collapse:collapse; font-size:14px; margin-top:10px; }
    .memo-table th, .memo-table td { border:1px solid #999; padding:8px 10px; text-align:left; }
    .memo-table th { background:#e9ecef; font-weight:700; }

    /* loader */
    .loader { display:inline-block; padding:6px 10px; background:#eef2f7; border-radius:6px; font-size:13px; margin-left:8px; }

    /* responsive */
    @media (max-width:900px) {
      .grid { grid-template-columns: 1fr; }
      .input-group { flex-direction:column; }
      .memo-container { padding:16px; margin:20px; }
      .banner { padding:12px; }
    }

    /* ===== print ===== */
    @media print {
      body { background: #fff; }
      /* hide everything except memo-container */
      body > #app > *:not(.memo-container) { display:none !important; }
      .memo-container { display:block !important; border: none; box-shadow:none; padding:0; margin:0; width:100%; }
      .memo-header { border-bottom:3px double #222; margin-bottom:6mm; padding-bottom:2mm; }
      /* ensure image prints */
      .memo-header img { max-height:90px; }
      @page { size: A4; margin: 8mm 10mm 8mm 10mm; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Banner: change the src to "image.png" if you prefer that filename -->
    <div class="banner" title="Academy banner">
      <img src="/mnt/data/Screenshot 2025-11-18 204301.png" alt="School banner - replace with image.png if desired">
    </div>

    <div class="page-head">
      <h1>ðŸ“š Book Sales Memo Generator</h1>
      <p class="lead">Select class, pick books, generate printable sales memo and optionally log sale to Google Sheet.</p>
    </div>

    <div class="content">
      <label for="class-select">Select Class:</label>
      <select id="class-select" onchange="displayBooks()">
        <option value="">-- Select Class --</option>
      </select>

      <div class="input-group">
        <div>
          <label for="student-name">Student Name:</label>
          <input type="text" id="student-name" placeholder="Enter student's name (optional)">
        </div>
        <div>
          <label for="student-id">Student ID:</label>
          <input type="text" id="student-id" placeholder="Enter student's ID (optional)">
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;justify-content:flex-end;">
          <div style="color:#666;font-size:12px;">Quick actions</div>
          <div class="actions">
            <button class="btn primary" onclick="generateMemo()">Generate Bill, Save Data, and Print</button>
            <button class="btn danger" onclick="resetForm()">Create New Bill</button>
          </div>
        </div>
      </div>

      <div id="books-list"></div>

      <div id="memo-output" class="memo-container" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /* =========================
       Your previous JS (kept mostly intact)
       Slightly trimmed comments to keep file compact
       ========================= */

    const SHEETS = [
      { name: "Nursery", gid: "489499898" },
      { name: "Reception", gid: "2027098770" },
      { name: "Year 1", gid: "1401175034" },
      { name: "Year 2", gid: "920652694" },
      { name: "Year 3", gid: "853416613" },
      { name: "Year 4", gid: "746344402" },
      { name: "Year 5", gid: "1210824589" },
      { name: "Year 6", gid: "863626512" },
      { name: "Year 7", gid: "790069678" },
      { name: "Year 8", gid: "622660697" },
      { name: "Year 9", gid: "2022019354" },
      { name: "Question Paper Set", gid: "596988486" }
    ];

    const BASE = "https://docs.google.com/spreadsheets/d/1htWKKFov6IgbkJTqrhXl-EvvHzZlyWHOsNAQScfarw0/export?format=csv&gid=";

    function csvToRows(str) {
      str = str.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const rows = [];
      let cur = [], field = '', inQuotes=false;
      for (let i=0;i<str.length;i++){
        const ch = str[i];
        if (inQuotes) {
          if (ch === '"') {
            if (str[i+1] === '"') { field += '"'; i++; }
            else inQuotes = false;
          } else field += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { cur.push(field); field=''; }
          else if (ch === '\n') { cur.push(field); field=''; rows.push(cur); cur=[]; }
          else field += ch;
        }
      }
      if (field !== '' || inQuotes) cur.push(field);
      if (cur.length>0) rows.push(cur);
      return rows;
    }

    function parseCSVToObjects(csvText) {
      const rows = csvToRows(csvText);
      if (!rows || rows.length === 0) return [];
      const headerRow = rows[0].map(h => (h||'').toString().trim());
      const map = { Subject: -1, Books: -1, Price: -1 };
      headerRow.forEach((h, idx) => {
        const key = (h||'').replace(/\s+/g,' ').trim().toLowerCase();
        if (/^subject\b/i.test(h) || key.includes('subject')) map.Subject = idx;
        else if (/^books?\b/i.test(h) || key.includes('book')) map.Books = idx;
        else if (/^price\b/i.test(h) || key.includes('price') || key.includes('rate') || key.includes('unit')) map.Price = idx;
      });
      if (map.Subject === -1) headerRow.forEach((h,idx)=>{ if (/(subject|sub)/i.test(h) && map.Subject===-1) map.Subject=idx; });
      if (map.Books === -1) headerRow.forEach((h,idx)=>{ if (/(book|title)/i.test(h) && map.Books===-1) map.Books=idx; });
      if (map.Price === -1) headerRow.forEach((h,idx)=>{ if (/(price|rate|unit)/i.test(h) && map.Price===-1) map.Price=idx; });
      if (map.Subject === -1 && headerRow.length >= 2) map.Subject = 1;
      if (map.Books === -1 && headerRow.length >= 3) map.Books = 2;
      if (map.Price === -1) map.Price = headerRow.length - 1;

      const data = [];
      for (let r=1;r<rows.length;r++){
        const row = rows[r];
        if (!row || row.every(c => (c||'').toString().trim()==='')) continue;
        const subject = (row[map.Subject]||'').toString().trim();
        const books = (row[map.Books]||'').toString().trim();
        let priceRaw = (row[map.Price]||'').toString().trim();
        priceRaw = priceRaw.replace(/[^0-9.\-]/g,'');
        const price = parseFloat(priceRaw) || 0;
        data.push({ Subject: subject || '-', Books: books || '-', Price: price });
      }
      return data;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const select = document.getElementById('class-select');
      SHEETS.forEach(s => {
        const option = document.createElement('option');
        option.value = s.name;
        option.textContent = s.name;
        select.appendChild(option);
      });
    });

    async function loadBooksForClass(className) {
      const sheet = SHEETS.find(s => s.name === className);
      if (!sheet) return [];
      const url = BASE + sheet.gid;
      const booksListDiv = document.getElementById('books-list');
      const loader = document.createElement('span');
      loader.className = 'loader';
      loader.textContent = 'Loading...';
      booksListDiv.innerHTML = '';
      booksListDiv.appendChild(loader);

      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          booksListDiv.innerHTML = '<div style="color:#a00;">Failed to load sheet (check sharing/public access).</div>';
          return [];
        }
        const csv = await resp.text();
        const items = parseCSVToObjects(csv);
        return items;
      } catch (err) {
        booksListDiv.innerHTML = '<div style="color:#a00;">Error fetching sheet data. See console.</div>';
        console.error('Error fetching sheet:', err);
        return [];
      }
    }

    async function displayBooks() {
      const selectedClass = document.getElementById('class-select').value;
      const booksListDiv = document.getElementById('books-list');
      booksListDiv.innerHTML = '';

      if (!selectedClass) return;

      const books = await loadBooksForClass(selectedClass);
      if (!books || books.length === 0) {
        booksListDiv.innerHTML = '<div style="color:#555;">No books found in sheet for this class.</div>';
        window.bookData = window.bookData || {};
        window.bookData[selectedClass] = [];
        return;
      }

      let html = `<h3 style="margin:0 0 8px 0;">Book List for ${selectedClass}</h3>`;
      html += `
        <table class="data-table" role="table">
          <thead>
            <tr>
              <th style="width:22%"><div style="display:flex;align-items:center;"><input type="checkbox" id="select-all-books" onchange="selectAllBooks(this.checked)"><label for="select-all-books" style="margin:0 0 0 8px;cursor:pointer;"> Subject (Select)</label></div></th>
              <th style="width:40%">Book Name</th>
              <th style="width:14%;text-align:right;">Unit Price (BDT)</th>
              <th style="width:12%;text-align:center;">Quantity</th>
              <th style="width:12%;text-align:right;">Total (BDT)</th>
            </tr>
          </thead>
          <tbody>
      `;

      books.forEach((book, index) => {
        const bookId = `book-${index}`;
        const priceDisplay = (typeof book.Price === 'number') ? book.Price.toLocaleString() : (book.Price || '0');
        html += `
          <tr id="${bookId}-row">
            <td>
              <input type="checkbox" id="check-book-${index}" data-index="${index}" onchange="updateQuantityAndCheckbox(this, 'checkbox')">
              ${escapeHtml(book.Subject)}
            </td>
            <td>${escapeHtml(book.Books)}</td>
            <td class="unit-price" data-price="${book.Price}" style="text-align:right;">${priceDisplay}</td>
            <td style="text-align:center;">
              <input type="number" min="0" value="0" id="qty-book-${index}" data-index="${index}" oninput="updateQuantityAndCheckbox(this, 'input')">
            </td>
            <td id="${bookId}-total" style="text-align:right;">0</td>
          </tr>
        `;
      });

      html += `
          <tr>
            <td colspan="4" style="text-align:right;">Grand Total:</td>
            <td id="grand-total" class="total-row" style="text-align:right;">0</td>
          </tr>
          </tbody>
        </table>
      `;

      booksListDiv.innerHTML = html;
      window.bookData = window.bookData || {};
      window.bookData[selectedClass] = books;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function selectAllBooks(checked) {
      const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
      const individualCheckboxes = document.querySelectorAll('#books-list input[type="checkbox"]');
      const value = checked ? 1 : 0;
      quantityInputs.forEach(input => { input.value = value; });
      individualCheckboxes.forEach(cb => {
        if (cb.id && cb.id.startsWith('check-book-')) cb.checked = checked;
      });
      calculateTotal();
    }

    function updateQuantityAndCheckbox(element, type) {
      const index = element.getAttribute('data-index');
      const checkbox = document.getElementById(`check-book-${index}`);
      const qtyInput = document.getElementById(`qty-book-${index}`);
      const selectAllCheckbox = document.getElementById('select-all-books');

      if (!checkbox || !qtyInput) return;

      if (type === 'checkbox') {
        if (element.checked) qtyInput.value = 1; else qtyInput.value = 0;
      } else if (type === 'input') {
        let quantity = parseInt(element.value) || 0;
        if (quantity < 0) { quantity = 0; element.value = 0; }
        checkbox.checked = quantity > 0;
      }

      if (selectAllCheckbox) {
        const selectedClass = document.getElementById('class-select').value;
        const totalBooks = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass].length : 0;
        const checkedCount = Array.from(document.querySelectorAll('#books-list input[type="checkbox"]')).filter(cb => cb.id.startsWith('check-book-') && cb.checked).length;
        selectAllCheckbox.checked = (checkedCount === totalBooks && totalBooks > 0);
      }

      calculateTotal();
    }

    function calculateTotal() {
      const selectedClass = document.getElementById('class-select').value;
      if (!selectedClass) return;
      const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];
      let grandTotal = 0;
      const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
      quantityInputs.forEach(input => {
        const index = input.getAttribute('data-index');
        const quantity = parseInt(input.value) || 0;
        const book = books[index];
        if (book) {
          const totalPrice = (Number(book.Price) || 0) * quantity;
          const el = document.getElementById(`book-${index}-total`);
          if (el) el.textContent = totalPrice.toLocaleString();
          grandTotal += totalPrice;
        }
      });
      const gt = document.getElementById('grand-total');
      if (gt) gt.textContent = grandTotal.toLocaleString() + ' BDT';
    }

    function generateMemo() {
      calculateTotal();
      const selectedClass = document.getElementById('class-select').value;
      const memoOutput = document.getElementById('memo-output');
      const studentName = document.getElementById('student-name').value;
      const studentId = document.getElementById('student-id').value;

      if (!selectedClass) { alert('Please select a Class.'); return; }

      let finalTotal = 0;
      const salesItems = [];
      const quantityInputs = document.querySelectorAll('#books-list input[type="number"]');
      const books = (window.bookData && window.bookData[selectedClass]) ? window.bookData[selectedClass] : [];

      quantityInputs.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
          const index = input.getAttribute('data-index');
          const book = books[index];
          const price = Number(book.Price) || 0;
          const totalPrice = price * quantity;
          finalTotal += totalPrice;
          salesItems.push({
            Subject: book.Subject,
            Book: book.Books,
            Price: price,
            Qty: quantity,
            Total: totalPrice
          });
        }
      });

      if (salesItems.length === 0) {
        alert('Please check or enter a quantity for at least one book.');
        return;
      }

      // Memo HTML - uses the same banner (update src if needed)
      let memoHTML = `
        <div class="memo-header">
          <img src="/mnt/data/Screenshot 2025-11-18 204301.png" alt="School banner - prints on memo">
          <h2>Book Sales Memo</h2>
          <p>Sales Date: <strong>${new Date().toLocaleDateString('en-US')}</strong></p>
          <p>Student Name: <strong>${studentName || 'N/A'}</strong> | Student ID: <strong>${studentId || 'N/A'}</strong></p>
          <p>Class: <strong>${selectedClass}</strong></p>
        </div>
        <table class="memo-table" role="table">
          <thead>
            <tr>
              <th>SL</th>
              <th>Book Name & Subject</th>
              <th style="text-align:right;">Unit Price (BDT)</th>
              <th style="text-align:center;">Qty</th>
              <th style="text-align:right;">Total Price (BDT)</th>
            </tr>
          </thead>
          <tbody>
      `;

      salesItems.forEach((item, i) => {
        memoHTML += `
          <tr>
            <td>${i+1}</td>
            <td>${escapeHtml(item.Book)} (${escapeHtml(item.Subject)})</td>
            <td style="text-align:right;">${item.Price.toLocaleString()}</td>
            <td style="text-align:center;">${item.Qty}</td>
            <td style="text-align:right;">${item.Total.toLocaleString()}</td>
          </tr>
        `;
      });

      memoHTML += `
          <tr class="total-row">
            <td colspan="4" style="text-align:right;">Grand Total Payable:</td>
            <td style="text-align:right;">${finalTotal.toLocaleString()} BDT</td>
          </tr>
        </tbody></table>
      `;

      memoOutput.innerHTML = memoHTML;
      memoOutput.style.display = 'block';

      // Log (no-cors stub) - update your script URL in the function below
      const logData = { class: selectedClass, studentName, studentId, total: finalTotal, items: salesItems };
      logSaleToGoogleSheet(logData);

      // trigger print
      window.print();
    }

    function logSaleToGoogleSheet(data) {
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwBxbzsIcvRK_RDjn4VPiet2dWEaHb1vuLxY6Gtjt09rtd5YkwJXGbIFawdlBIVzcnm/exec';
      if (!SCRIPT_URL || !SCRIPT_URL.includes('https://script.google.com/macros/s/')) {
        console.warn('âš ï¸ Data saving not configured. Add your Apps Script URL.');
        return;
      }
      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(()=>console.log('Sales data sent')).catch(err=>console.error(err));
    }

    function resetForm() {
      document.getElementById('class-select').value = '';
      document.getElementById('student-name').value = '';
      document.getElementById('student-id').value = '';
      document.getElementById('books-list').innerHTML = '';
      document.getElementById('memo-output').style.display = 'none';
    }

    window.bookData = window.bookData || {};
  </script>
</body>
</html>
